var Ce=Object.defineProperty;var Ie=(r,e,t)=>e in r?Ce(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var o=(r,e,t)=>Ie(r,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();function G(r){document.querySelectorAll(r).forEach(e=>e.classList.remove("hidden"))}function y(r){document.querySelectorAll(r).forEach(e=>e.classList.add("hidden"))}function Ue(r){document.querySelectorAll(r).forEach(e=>e.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden"))}function X(r){return new Promise(e=>setTimeout(e,r))}function V(r,e,t){const n=document.createElement("button");return n.innerText=e,u(n,"click",t),typeof r=="string"&&(r=document.querySelector(r)),r.append(n),n}function u(r,e,t,n){typeof r=="string"?r=document.querySelectorAll(r):r instanceof Array||(r=[r]);for(const s of r)s.addEventListener(e,t,n)}function J(r,e,t,n){r.removeEventListener(e,t,n)}class De{constructor(e,t){o(this,"_device");o(this,"_parser");o(this,"_onConnectionChanged");o(this,"_waitingForUserSelection");this._parser=e,this._onConnectionChanged=t,this._waitingForUserSelection=!1,u(navigator.usb,"connect",n=>{this._waitingForUserSelection||this.connect(!0).catch(()=>{})})}get isConnected(){return!!this._device}async _startReading(){try{for(;this._device;){const e=await this._device.transferIn(3,512);e.status!=="ok"?this.disconnect():this._parser.process(new Uint8Array(e.data.buffer))}}catch(e){console.error(e),this.disconnect()}}async _send(e){if(this._device)try{await this._device.transferOut(3,new Uint8Array(e))}catch(t){console.error(t),this.disconnect()}}async sendKeys(e){this._send([67,e])}async sendNoteOn(e,t){this._send([75,e,t])}async sendNoteOff(){this._send([75,255])}async _reset(){await this._device.transferOut(3,new Uint8Array([68])),await X(50),this._parser.reset(),await this._device.transferOut(3,new Uint8Array([69,82]))}async disconnect(){const e=this._device;e&&(this._device=null,await e.transferOut(3,new Uint8Array([68])).catch(()=>{}),await e.close().catch(()=>{}),this._onConnectionChanged(!1))}async connect(e=!1){if(!this._device)try{const t=(await navigator.usb.getDevices()).filter(n=>n.vendorId===5824&&n.productId===1162);if(this._device=t.length===1?t[0]:null,this._device||(e?this._onConnectionChanged(!1):this._device=await this._requestDevice()),!this._device)return;await this._device.open(),await this._device.selectConfiguration(1),await this._device.claimInterface(1),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:34,value:3,index:1}),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:32,value:0,index:1},new Uint8Array([128,37,0,0,0,0,8])),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(t){throw console.error(t),this.disconnect(t),t}}async _requestDevice(){this._waitingForUserSelection=!0;try{return await navigator.usb.requestDevice({filters:[{vendorId:5824,productId:1162}]})}catch(e){if(e.code!==DOMException.NOT_FOUND_ERR)throw e;return null}finally{this._waitingForUserSelection=!1}}}class Be{constructor(e,t){o(this,"_port");o(this,"_parser");o(this,"_onConnectionChanged");o(this,"_waitingForUserSelection");this._parser=e,this._onConnectionChanged=t,this._waitingForUserSelection=!1,u(navigator.serial,"connect",n=>{this._waitingForUserSelection||this.connect(!0).catch(()=>{})})}get isConnected(){return!!this._port}async _startReading(){try{for(;this._port;){const{value:e,done:t}=await this._port.reader.read();if(e)try{this._parser.process(e)}catch(n){console.error(n)}if(t)return}}catch(e){console.error(e),this.disconnect()}}async _send(e){if(!(!this._port||!this._port.writer))try{await this._port.writer.write(new Uint8Array(e))}catch(t){console.error(t),this.disconnect()}}async sendKeys(e){this._send([67,e])}async sendNoteOn(e,t){this._send([75,e,t])}async sendNoteOff(){this._send([75,255])}async _reset(){await this._port.writer.write(new Uint8Array([68])),await X(50),this._parser.reset(),await this._port.writer.write(new Uint8Array([69,82]))}async disconnect(){const e=this._port;e&&(this._port=null,e.writer&&await e.writer.write(new Uint8Array([68])).catch(()=>{}),e.reader&&await e.reader.cancel().catch(()=>{}),await e.close().catch(()=>{}),this._onConnectionChanged(!1))}async connect(e=!1){if(!this._port)try{const t=(await navigator.serial.getPorts()).filter(n=>{const s=n.getInfo();return s.usbVendorId===5824&&s.usbProductId===1162});if(this._port=t.length===1?t[0]:null,this._port||(e?this._onConnectionChanged(!1):this._port=await this._requestPort()),!this._port)return;await this._port.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none",bufferSize:4096}),this._port.reader=await this._port.readable.getReader(),this._port.writer=await this._port.writable.getWriter(),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(t){throw console.error(t),this.disconnect(t),t}}async _requestPort(){this._waitingForUserSelection=!0;try{return await navigator.serial.requestPort({filters:[{usbVendorId:5824,usbProductId:1162}]})}catch(e){if(e.code!==DOMException.NOT_FOUND_ERR)throw e;return null}finally{this._waitingForUserSelection=!1}}}const E=Symbol("normal"),ue=Symbol("escape"),de=Symbol("error"),Fe=new Uint8Array(0);class Me{constructor(e){o(this,"_state",E);o(this,"_buffer",new Uint8Array(512));o(this,"_i",0);o(this,"_renderer");this._renderer=e}_processFrame(e){switch(e[0]){case 254:e.length===12?this._renderer.drawRect(e[1]+e[2]*256,e[3]+e[4]*256,e[5]+e[6]*256,e[7]+e[8]*256,e[9],e[10],e[11]):console.log("Bad RECT frame");break;case 253:e.length===12?this._renderer.drawText(e[1],e[2]+e[3]*256,e[4]+e[5]*256,e[6],e[7],e[8]):console.log("Bad TEXT frame");break;case 252:e.length===4?this._renderer.drawWave(e[1],e[2],e[3],Fe):e.length<=324?this._renderer.drawWave(e[1],e[2],e[3],e.subarray(4)):console.log("Bad WAVE frame");break;case 251:e.length!==3&&console.log("Bad JPAD frame");break;case 255:this._renderer.setFont(e[5]);break;default:console.log("BAD FRAME")}}process(e){for(let t=0;t<e.length;t++){const n=e[t];switch(this._state){case E:switch(n){case 192:this._processFrame(this._buffer.subarray(0,this._i)),this._i=0;break;case 219:this._state=ue;break;default:this._buffer[this._i++]=n;break}break;case ue:switch(n){case 220:this._buffer[this._i++]=192,this._state=E;break;case 221:this._buffer[this._i++]=219,this._state=E;break;default:this._state=de,console.log("Unexpected SLIP sequence");break}break;case de:switch(n){case 192:this._state=E,this._i=0,console.log("SLIP recovered");break}}}}reset(){this._state=E,this._i=0}}let Ne=class{constructor(e,t){o(this,"_canvas");o(this,"_ctx");o(this,"_textNodes",[]);o(this,"_backgroundColour","rgb(0, 0, 0)");o(this,"_frameQueued",!1);o(this,"_rects",[]);o(this,"_waveColour","rgb(255, 255, 255)");o(this,"_waveData",new Uint8Array(320));o(this,"_waveOn",!1);o(this,"_textUpdates",{});o(this,"_onBackgroundChanged");o(this,"_fontConfig",[[8,10,0,0],[10,12,0,-40]]);o(this,"_fontId",0);this._backgroundColour=`rgb(${e[0]}, ${e[1]}, ${e[2]})`,this._onBackgroundChanged=t,this._canvas=document.getElementById("canvas"),this._ctx=canvas.getContext("2d"),this._buildText()}setFont(e){this._fontId!=e&&(this._fontId=e,this._buildText(),this.clear())}_buildText(){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg"),n=document.getElementById("canvas");for(t.setAttributeNS(null,"viewBox","0 0 640 480"),t.setAttributeNS(null,"id","screen"),t.setAttributeNS(null,"style",n.getAttribute("style")),this._fontId==1&&t.setAttributeNS(null,"class","big");t.firstChild;)t.removeChild(t.lastChild);var s=0;this._fontId==1&&(s=3);for(let i=s;i<25;i++)for(let c=0;c<39;c++){const l=document.createElementNS(e,"text"),f=c*(this._fontConfig[this._fontId][0]*2);var a=0;this._fontId==1?(a=(i-3)*(this._fontConfig[this._fontId][1]*2)+this._fontConfig[this._fontId][1]*2-16,i==3&&(a+=20)):a=i*(this._fontConfig[this._fontId][1]*2)+this._fontConfig[this._fontId][1]*2,this._fontId==1&&(a+=10),l.setAttributeNS(null,"x",f),l.setAttributeNS(null,"y",a),l.setAttributeNS(null,"fill","_000");const d=document.createTextNode("");l.appendChild(d),t.appendChild(l),this._textNodes[i*39+c]={node:d,char:32,fill:"_000"}}document.contains(document.getElementById("screen"))&&document.getElementById("screen").remove(),this._canvas.insertAdjacentElement("afterend",t)}_renderFrame(){for(let e=0;e<this._rects.length;e++){const t=this._rects[e];this._ctx.fillStyle=t.colour,this._ctx.fillRect(t.x,t.y,t.w,t.h)}if(this._rects.length=0,this._waveUpdated&&(this._ctx.fillStyle=this._backgroundColour,this._ctx.fillRect(0,0,320,21),this._waveOn)){this._ctx.fillStyle=this._waveColour;for(let e=0;e<this._waveData.length;e++){if(this._waveData[e]==255)continue;const t=Math.min(this._waveData[e],20);this._ctx.fillRect(e,t,1,1)}}this._waveUpdated=!1;for(const[e,t]of Object.entries(this._textUpdates)){const n=t.node;t.char!==n.char&&(n.node.nodeValue=String.fromCharCode(t.char),n.char=t.char),t.fill!==n.fill&&(n.node.parentElement.setAttributeNS(null,"fill",t.fill),n.fill=t.fill)}this._textUpdates={},this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame(()=>this._renderFrame()),this._frameQueued=!0)}drawRect(e,t,n,s,a,i,c){const l=`rgb(${a}, ${i}, ${c})`;e===0&&t===0&&n>=320&&s>=240&&(this._rects.length=0,this._backgroundColour=l,this._onBackgroundChanged(a,i,c)),this._fontId==1&&(t+=this._fontConfig[this._fontId][3]),this._rects.push({colour:l,x:e,y:t,w:n,h:s}),this._queueFrame()}drawText(e,t,n,s,a,i){const c=Math.floor(n/this._fontConfig[this._fontId][1])*39+Math.floor(t/this._fontConfig[this._fontId][0]);this._textNodes[c]&&(this._textUpdates[c]={node:this._textNodes[c],char:e,fill:`rgb(${s}, ${a}, ${i})`},this._queueFrame())}drawWave(e,t,n,s){this._waveColour=`rgb(${e}, ${t}, ${n})`,s.length!=0?(this._waveData.fill(-1),this._waveData.set(s,320-s.length),this._waveOn=!0,this._waveUpdated=!0,this._queueFrame()):this._waveOn&&(this._waveOn=!1,this._waveUpdated=!0,this._queueFrame())}clear(){this._rects=[{colour:this._backgroundColour,x:0,y:0,w:320,h:240}],this._waveOn=!1,this._waveUpdated=!0,this._textUpdates={};for(let e=0;e<this._textNodes.length;e++)this._textUpdates[e]={node:this._textNodes[e],char:32,fill:"rgb(0, 0, 0)"};this._queueFrame()}};const Oe="#version 300 es precision highp float; uniform sampler2D src; in vec2 srcCoord; out vec4 fragColour; void main() { fragColour = texelFetch(src, ivec2(srcCoord), 0); }",Ge="#version 300 es out vec2 srcCoord; const vec2 corners[] = vec2[]( vec2(0, 0), vec2(0, 1), vec2(1, 0), vec2(1, 1)); void main() { vec2 pos = corners[gl_VertexID] * vec2(2.0, 2.0) + vec2(-1.0, -1.0); gl_Position = vec4(pos, 0.0, 1.0); srcCoord = corners[gl_VertexID] * vec2(320.0, 240.0); }",Le="#version 300 es precision highp float; in vec3 colourV; out vec4 fragColour; void main() { fragColour = vec4(colourV, 1.0); }",ke="#version 300 es layout(location = 0) in vec4 shape; layout(location = 1) in vec3 colour; out vec3 colourV; const vec2 corners[] = vec2[]( vec2(0, 0), vec2(0, 1), vec2(1, 0), vec2(1, 1)); const vec2 camScale = vec2(2.0 / 320.0, -2.0 / 240.0); const vec2 camOffset = vec2(-160.0, -120.0); void main() { vec2 pos = shape.xy; vec2 size = shape.zw; pos = ((corners[gl_VertexID] * size + pos) + camOffset) * camScale; gl_Position = vec4(pos, 0.0, 1.0); colourV = colour; }",Pe="#version 300 es precision highp float; uniform sampler2D font; in vec2 fontCoord; in vec3 colourV; out vec4 fragColour; void main() { vec4 fontTexel = texelFetch(font, ivec2(fontCoord), 0); fragColour = vec4(colourV, fontTexel.r); }",Ve="#version 300 es layout(location = 0) in vec3 colour; layout(location = 1) in float char; out vec3 colourV; out vec2 fontCoord; const vec2 corners[] = vec2[]( vec2(0, 0), vec2(0, 1), vec2(1, 0), vec2(1, 1)); const vec2 camScale = vec2(2.0 / 320.0, -2.0 / 240.0); const vec2 camOffset = vec2(-160.0, -120.0); const vec2 size = vec2(5.0, 7.0); void main() { float row; float col = modf(float(gl_InstanceID) / 40.0, row) * 40.0; vec2 pos = vec2(col, row) * vec2(8.0, 10.0) + vec2(0.0, 3.0); pos = ((corners[gl_VertexID] * size + pos) + camOffset) * camScale; gl_Position = vec4(char == 0.0 ? vec2(2.0) : pos, 0.0, 1.0); colourV = colour; fontCoord = (vec2(char - 1.0, 0.0) + corners[gl_VertexID]) * size; }",Ye="#version 300 es precision highp float; uniform sampler2D font; in vec2 fontCoord; in vec3 colourV; out vec4 fragColour; void main() { vec4 fontTexel = texelFetch(font, ivec2(fontCoord), 0); fragColour = vec4(colourV, fontTexel.r); }",je="#version 300 es layout(location = 0) in vec3 colour; layout(location = 1) in float char; out vec3 colourV; out vec2 fontCoord; const vec2 corners[] = vec2[]( vec2(0, 0), vec2(0, 1), vec2(1, 0), vec2(1, 1)); const vec2 camScale = vec2(2.0 / 320.0, -2.0 / 240.0); const vec2 camOffset = vec2(-160.0, -120.0); const vec2 size = vec2(8.0, 9.0); void main() { float row; float col = modf(float(gl_InstanceID) / 40.0, row) * 40.0; row = row - 3.0; vec2 pos = vec2(col, row) * vec2(10.0, 12.0) + vec2(0.0, 0.0); if(row == 0.0) { pos = pos + vec2(0.0, 5.0); } pos = ((corners[gl_VertexID] * size + pos) + camOffset) * camScale; gl_Position = vec4(char == 0.0 ? vec2(2.0) : pos, 0.0, 1.0); colourV = colour; fontCoord = (vec2(char - 1.0, 0.0) + corners[gl_VertexID]) * size; }",We="#version 300 es precision highp float; uniform vec3 colour; out vec4 fragColour; void main() { fragColour = vec4(colour, 1.0); }",ze="#version 300 es layout(location = 0) in uint value; const vec2 camScale = vec2(2.0 / 320.0, -2.0 / 240.0); const vec2 camOffset = vec2(-160.0, -120.0); void main() { vec2 pos = vec2(float(gl_VertexID), float(value)); pos = (pos + vec2(0.5) + camOffset) * camScale; gl_PointSize = 1.0; gl_Position = vec4(pos, 0.0, 1.0); }",Xe=Object.freeze(Object.defineProperty({__proto__:null,blit_frag:Oe,blit_vert:Ge,rect_frag:Le,rect_vert:ke,text1_frag:Pe,text1_vert:Ve,text2_frag:Ye,text2_vert:je,wave_frag:We,wave_vert:ze},Symbol.toStringTag,{value:"Module"})),Ze="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdYAAAAHAQMAAACPwf4nAAAABlBMVEUAAAD///+l2Z/dAAABiElEQVQYGQXBwUtTcQDA8e/77dneYepTGBSocxakl9DhoUO45yiELpP8B6pBpwjFwwosf4qYF5vhpYsVZBBBYB2iYIdn5OZJEsJuMkg09LA3Efr9dHs/Px9mpdc/I4H0VZMwVQXWVn6l2thWOWdjN/9GlQYK5Zjr2LgdbvdbH8ADhrJSEC++sn4swPH3m3o4s0R3Mhcv9d262yuakmPx9VHQz9TFOnBCRUoAgD19xQ4/fot8SUvo8S4Dws0OPyeESqvdCADQpNNTGIB7mU8G0FtHu2MPBgU7739jfW2VmWjxoHjtUTCx0DXpRa+34ISqOXIDTmvSh+b7l5ZTvjgrpxaTo2jtiw+Cvtwa4e3azFwj0raZcik8ziz6evOOrVDHnfvszb+kAgFRy8cG6MI+nZAhQv5ZPQE8SwEg3M/jTxDgUwf++VhlQQBL6KceMWgZ/4lzoQ1A4g1aEq89YcJE/bXjwovCSnV9++yd2vj1cGqkfeB/qSNSMcYs1/I9h+UgNjT9t2bCrDwHUjqY5UZP3NUAAAAASUVORK5CYII=",He="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAvAAAAAJCAMAAABjeuiwAAAABlBMVEX///8AAABVwtN+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAE9WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgOS4wLWMwMDEgNzkuYzAyMDRiMmRlZiwgMjAyMy8wMi8wMi0xMjoxNDoyNCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDI0LjUgKE1hY2ludG9zaCkiIHhtcDpDcmVhdGVEYXRlPSIyMDIzLTA1LTIzVDEzOjEzOjAyLTA3OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAyMy0wNS0yM1QxMzoyNjoyMS0wNzowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyMy0wNS0yM1QxMzoyNjoyMS0wNzowMCIgZGM6Zm9ybWF0PSJpbWFnZS9wbmciIHBob3Rvc2hvcDpDb2xvck1vZGU9IjIiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ZTM1OGJkODItNzUyZS00MGU1LTliMTAtOTdjMjU4N2I4NzBlIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOmUzNThiZDgyLTc1MmUtNDBlNS05YjEwLTk3YzI1ODdiODcwZSIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOmUzNThiZDgyLTc1MmUtNDBlNS05YjEwLTk3YzI1ODdiODcwZSI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6ZTM1OGJkODItNzUyZS00MGU1LTliMTAtOTdjMjU4N2I4NzBlIiBzdEV2dDp3aGVuPSIyMDIzLTA1LTIzVDEzOjEzOjAyLTA3OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjQuNSAoTWFjaW50b3NoKSIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5OT74hAAADKklEQVRYhcVYR6LdIAzU5P/7X3myMBJqYPxKooVNUQNVGxAKRESEAh2KLogIIfb064mGAonke+B4gyKCOZ8A6VbnLtP8kWDYW1inQ60qZW5wqZ+u2626OR191GMxT/x270560CRcUbZVb7tgauNfdgIS0uhFeOJMgewCDA5uLiIiv1vC6zHIWE9AgYCEiIDN/lYtKE9OheiuSyHuGL0dZxcY1SzDAYeyJCgQEtcVEWFf14Nmum/aVa+gd1hi3mOVv3png91BvLeZfDB1Ch4/zPYEVvjwQ5bRv4bsD3HeODwhw4Utw4/0ne/oQjCP15Pfx2ZwiNfgKAGMOBWZtaqL2StaPWgU5vW0f6aboj7wsHtMkCj36ARnYxXzjakLzFZOzpAZXyu0LBR5w86upoSKxih03wlkcA4PpWWwDYoBe2vw3KIvVqvAoDmidg8x3/peLMdrgTf18npMnmqg5zl1B01JDYKzf5fDwT2zA9VWjCsHdN2gr3Bekd5Bu7cjZeBoa7MVjgGPtF+AlyY1w0MzPLWLsUS+8wfrDJgO7K7DoUrCmgcrg/hWnx7JF5wE3oKB01yxO4RSR/6dS3ZG6dnH4xnoNNWLqYGfj27pIDTgi1MK9SHugwGGzgEX8HZCO+F7F/CVlhSse3hYvJyd1NqF/O1adLDt3i/gcXxPb6WLMwrVpq1yNdqR3jYx/pus74verpSuHS0q5AoRxq5d4tZXp0GuTwzGOztQJDB7inFHcfotlxNaXG8zT6mcgX4bZ1rhfgvr3NJc7jW+7T5Q9L8V/k1L4xI47JEoPvVptWmfJ/TSQN73PLOEc1ZRZjs1NLdw1wOjme3xz0pLLPr3/Ot/JSEc/plj/Wn0AARCcnQ1GEFQ+0D0gjCUaG/le/6ucv2KiAAAgr8rnq43QO1aXlL26R+K0UMKhItbk9HsXGgW105Qq+p/+lXyJbGlfwlyDm31U/+eX24NjMdVZs1lcjeAlaDFj96ljyVYoaVUjTxI/RSaId05yoliu1V7swVdXC8t05oe/oEkOOsZjJDpW2n2uWjAiHcKKjXn4jVmnmf8fp7/Cm3x9y1Mey9/ARS9smac9Y/6AAAAAElFTkSuQmCC",$=1024;class qe{constructor(e,t){o(this,"_canvas");o(this,"_gl");o(this,"_bg",[0,0,0]);o(this,"_frameQueued",!1);o(this,"_onBackgroundChanged");o(this,"_fontConfig",[[8,10,0,0],[10,12,0,-40]]);o(this,"_fontId",0);o(this,"_rectShader");o(this,"_rectVao");o(this,"_rectShapes",new Uint16Array($*6));o(this,"_rectColours",new Uint8Array(this._rectShapes.buffer,8));o(this,"_rectCount",0);o(this,"_rectsClear",!0);o(this,"_rectsTex");o(this,"_rectsFramebuffer");o(this,"_blitShader");o(this,"_textShader");o(this,"_textVao");o(this,"_textTex");o(this,"_textColours",new Uint8Array(40*24*3));o(this,"_textChars",new Uint8Array(40*24));o(this,"_waveData",new Uint8Array(320));o(this,"_waveColour",new Float32Array([.5,1,1]));o(this,"_waveOn",!1);this._bg=[e[0]/255,e[1]/255,e[2]/255],this._onBackgroundChanged=t,this._canvas=document.getElementById("canvas"),this._gl=this._canvas.getContext("webgl2",{alpha:!1,antialias:!1});const n=this._gl;this._setupRects(n),this._setupText(n),this._setupWave(n),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.viewport(0,0,320,240),this._queueFrame()}setFont(e){if(this._fontId==e)return;this._fontId=e;const t=this._gl;this._setupText(t)}_setupRects(e){this._rectShader=I(e,"rect"),this._rectVao=e.createVertexArray(),e.bindVertexArray(this._rectVao),this._rectShapes.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._rectShapes.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._rectShapes,e.STREAM_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,4,e.UNSIGNED_SHORT,!1,12,0),e.vertexAttribDivisor(0,1),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,e.UNSIGNED_BYTE,!0,12,8),e.vertexAttribDivisor(1,1),this._rectsTex=e.createTexture(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._rectsTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,320,240,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),this._rectsFramebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._rectsTex,0),this._blitShader=I(e,"blit"),e.useProgram(this._blitShader),e.uniform1i(e.getUniformLocation(this._blitShader,"src"),0)}_renderRects(e){this._rectsClear&&(e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.clearColor(this._bg[0],this._bg[1],this._bg[2],1),e.clear(e.COLOR_BUFFER_BIT),this._rectsClear=!1),this._rectCount>0&&(e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.useProgram(this._rectShader),e.bindVertexArray(this._rectVao),e.bindBuffer(e.ARRAY_BUFFER,this._rectShapes.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._rectShapes.subarray(0,this._rectCount*6)),e.drawArraysInstanced(e.TRIANGLE_STRIP,0,4,this._rectCount),this._rectCount=0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(this._blitShader),e.drawArrays(e.TRIANGLE_STRIP,0,4)}drawRect(e,t,n,s,a,i,c){if(e===0&&t===0&&n>=320&&s>=240)this._onBackgroundChanged(a,i,c),this._bg=[a/255,i/255,c/255],this._rectCount=0,this._rectsClear=!0;else if(this._rectCount<$){const l=this._rectCount;this._rectShapes[l*6+0]=e,this._rectShapes[l*6+1]=t&&t+this._fontConfig[this._fontId][3],this._rectShapes[l*6+2]=n,this._rectShapes[l*6+3]=s,this._rectColours[l*12+0]=a,this._rectColours[l*12+1]=i,this._rectColours[l*12+2]=c,this._rectCount++}this._rectCount>=$&&this._renderRects(this._gl),this._queueFrame()}_setupText(e){if(this._fontId==0?this._textShader=I(e,"text1"):this._textShader=I(e,"text2"),e.useProgram(this._textShader),e.uniform1i(e.getUniformLocation(this._textShader,"font"),1),this._textVao=e.createVertexArray(),e.bindVertexArray(this._textVao),this._textColours.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._textColours.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._textColours,e.DYNAMIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,3,e.UNSIGNED_BYTE,!0,0,0),e.vertexAttribDivisor(0,1),this._textChars.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._textChars.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._textChars,e.DYNAMIC_DRAW),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,1,e.UNSIGNED_BYTE,!1,0,0),e.vertexAttribDivisor(1,1),this._textTex=e.createTexture(),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),this._fontId==0){e.texImage2D(e.TEXTURE_2D,0,e.RGBA,470,7,0,e.RGBA,e.UNSIGNED_BYTE,null);const t=new Image;t.onload=()=>{e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,470,7,0,e.RGBA,e.UNSIGNED_BYTE,t),this._queueFrame()},t.src=Ze}else{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,752,9,0,e.RGBA,e.UNSIGNED_BYTE,null);const t=new Image;t.onload=()=>{e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,752,9,0,e.RGBA,e.UNSIGNED_BYTE,t),this._queueFrame()},t.src=He}}_renderText(e){e.useProgram(this._textShader),e.bindVertexArray(this._textVao),this._textColours.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._textColours.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._textColours),this._textColours.updated=!1),this._textChars.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._textChars.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._textChars),this._textChars.updated=!1),e.drawArraysInstanced(e.TRIANGLE_STRIP,0,4,40*24)}drawText(e,t,n,s,a,i){const c=Math.floor(n/this._fontConfig[this._fontId][1])*40+Math.floor(t/this._fontConfig[this._fontId][0]);c>=960||(this._textChars[c]=e-32,this._textChars.updated=!0,this._textColours[c*3+0]=s,this._textColours[c*3+1]=a,this._textColours[c*3+2]=i,this._textColours.updated=!0,this._queueFrame())}_setupWave(e){this._waveShader=I(e,"wave"),this._waveShader.colourUniform=e.getUniformLocation(this._waveShader,"colour"),this._waveVao=e.createVertexArray(),e.bindVertexArray(this._waveVao),this._waveData.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._waveData.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._waveData,e.STREAM_DRAW),e.enableVertexAttribArray(0),e.vertexAttribIPointer(0,1,e.UNSIGNED_BYTE,1,0)}_renderWave(e){this._waveOn&&(e.useProgram(this._waveShader),e.uniform3fv(this._waveShader.colourUniform,this._waveColour),e.bindVertexArray(this._waveVao),this._waveData.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._waveData.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._waveData),this._waveData.updated=!1),e.drawArrays(e.POINTS,0,320))}drawWave(e,t,n,s){this._waveColour[0]=e/255,this._waveColour[1]=t/255,this._waveColour[2]=n/255,s.length!=0?(this._waveData.fill(-1),this._waveData.set(s,320-s.length),this._waveData.updated=!0,this._waveOn=!0,this._queueFrame()):this._waveOn&&(this._waveOn=!1,this._queueFrame())}_renderFrame(){const e=this._gl;this._renderRects(e),this._renderText(e),this._renderWave(e),this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame(()=>this._renderFrame()),this._frameQueued=!0)}clear(){this._rectsClear=!0,this._rectCount=0,this._textChars.fill(0),this._textChars.updated=!0,this._waveOn=!1,this._queueFrame()}}function fe(r,e,t){const n=r.createShader(t);if(r.shaderSource(n,Xe[e]),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS))throw new Error(`Failed to compile shader (${e}): ${r.getShaderInfoLog(n)}`);return n}function Ke(r,e,t,n){const s=r.createProgram();if(r.attachShader(s,t),r.attachShader(s,n),r.linkProgram(s),!r.getProgramParameter(s,r.LINK_STATUS))throw new Error(`Failed to link program (${e}): ${r.getProgramInfoLog(s)}`);return s}function I(r,e){return Ke(r,e,fe(r,`${e}_vert`,r.VERTEX_SHADER),fe(r,`${e}_frag`,r.FRAGMENT_SHADER))}const $e=30*60*1e3;let he=!1;function _e(){he||(window.location.reload(),he=!0)}let ee=()=>{};u("#reload button","click",()=>ee());async function Qe(){u(navigator.serviceWorker,"controllerchange",()=>_e());let r=!navigator.serviceWorker.controller;const e=await navigator.serviceWorker.register("worker.js");u(e,"updatefound",()=>{if(r){r=!1;return}const t=e.installing;u(t,"statechange",()=>{t.state==="installed"&&(navigator.serviceWorker.controller?ee=()=>t.postMessage({action:"skipWaiting"}):ee=_e,G("#reload"))})}),setInterval(()=>e.update(),$e)}u("#menu-button","click",()=>Ue("#settings"));u("#settings","click",r=>{r.target.id==="settings"&&y("#settings")});const M={},ae={};T("showControls","Show Controls",!1);T("hideMenu","Hide Menu",!1);T("enableAudio","Enable Audio",!0);Je("displayType","Display Type",{webgl2:"WebGL2",old:"Canvas + SVG"},"webgl2");T("snapPixels","Snap Pixels",!0);T("virtualKeyboard","Virtual Keyboard",!0);T("preventSleep","Prevent Sleep",!1);Z("controlMapping","Control Mapping");Z("firmware","Load Firmware");Z("fullscreen","Fullscreen");Z("about","About");w("hideMenu",r=>document.getElementById("settings").classList.toggle("auto-hide",r));function T(r,e,t){const n=H(r,t),s=document.createElement("div");s.classList.add("setting");const a=document.createElement("label");a.innerText=e,s.append(a);const i=document.createElement("input");i.setAttribute("type","checkbox"),i.checked=n,a.append(i),u(i,"change",()=>S(r,i.checked)),document.getElementById("settings").append(s)}function Je(r,e,t,n){const s=H(r,n),a=document.createElement("div");a.classList.add("setting");const i=document.createElement("label");i.innerText=e,a.append(i);const c=document.createElement("select");for(const[l,f]of Object.entries(t)){const d=document.createElement("option");d.value=l,d.text=f,c.append(d)}c.value=s,i.append(c),u(c,"change",()=>S(r,c.value)),document.getElementById("settings").append(a)}function Z(r,e){const t=document.createElement("div");t.classList.add("setting"),V(t,e,()=>{y("#settings"),M[r]&&M[r]()}),document.getElementById("settings").append(t)}function H(r,e){let t=localStorage[r];return t=t===void 0?e:JSON.parse(t),ae[r]=t,t}function S(r,e){ae[r]=e,M[r]&&M[r](e),localStorage[r]=JSON.stringify(e)}function w(r,e){M[r]=e,g(r)!==void 0&&e(g(r))}function g(r){return ae[r]}const et=Object.freeze({KeyA:0,KeyW:1,KeyS:2,KeyE:3,KeyD:4,KeyF:5,KeyT:6,KeyG:7,KeyY:8,KeyH:9,KeyU:10,KeyJ:11,KeyK:12,KeyO:13,KeyL:14,KeyP:15,Semicolon:16,Quote:17,BracketLeft:"velDown",BracketRight:"velUp",Minus:"octDown",Equal:"octUp"});let Y,be=!0,U=3,D=103,pe=null;function tt(r,e,t){if(!be||!t||t.ctrlKey||t.metaKey||t.altKey)return!1;const n=et[r];if(n===void 0)return!1;if(t.repeat)return!0;switch(n){case"octDown":e&&(U=Math.max(U-1,0));break;case"octUp":e&&(U=Math.min(U+1,10));break;case"velDown":e&&(D=Math.max(D-8,7));break;case"velUp":e&&(D=Math.min(D+8,127));break;default:const s=n+U*12;if(s>128)return!1;e?(pe=n,Y.sendNoteOn(s,D)):n===pe&&Y.sendNoteOff();break}return!0}function rt(r){Y=r,w("virtualKeyboard",e=>{be=e,Y.sendNoteOff()})}let te,B=0;const nt={up:6,down:5,left:7,right:2,select:4,start:3,option:1,edit:0},ye=Object.freeze({ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",ShiftLeft:"select",Space:"start",KeyZ:"option",KeyX:"edit",Gamepad12:"up",Gamepad64:"up",Gamepad13:"down",Gamepad65:"down",Gamepad14:"left",Gamepad66:"left",Gamepad15:"right",Gamepad67:"right",Gamepad8:"select",Gamepad2:"select",Gamepad5:"select",Gamepad9:"start",Gamepad3:"start",Gamepad1:"option",Gamepad0:"edit"}),_={};function R(r,e,t){if(r){if(b){t&&t.preventDefault(),e&&b(r);return}tt(r,e,t)||Ee(_[r],e,t)}}function k(r,e){const t=e.target.dataset.action;t&&(q&&r&&!b?lt(e.target,t):Ee(t,r,e))}function Ee(r,e,t){if(!r)return;t&&t.preventDefault();const n=nt[r];if(n===void 0)return;const s=e?B|1<<n:B&~(1<<n);s!==B&&(B=s,te.sendKeys(B),document.querySelector(`#controls > [data-action="${r}"]`).classList.toggle("active",e))}function st(r){te=r,rt(te),u(document,"keydown",t=>R(t.code,!0,t)),u(document,"keyup",t=>R(t.code,!1,t));const e=document.getElementById("controls");u(e,"mousedown",t=>k(!0,t)),u(e,"touchstart",t=>k(!0,t)),u(e,"mouseup",t=>k(!1,t)),u(e,"touchend",t=>k(!1,t)),V("#mapping-buttons","Reset to Default",ut),V("#mapping-buttons","Clear All",dt),V("#mapping-buttons","Done",ot),Object.assign(_,H("inputMap",ye))}let j=!1;const re=[],at={0:[!0,!1,!1,!1],1:[!0,!1,!1,!0],2:[!1,!1,!1,!0],3:[!1,!0,!1,!0],4:[!1,!0,!1,!1],5:[!1,!0,!0,!1],6:[!1,!1,!0,!1],7:[!0,!1,!0,!1],8:[!1,!1,!1,!1],15:[!1,!1,!1,!1]};function Re(){if(!j)return;let r=!1;for(const e of navigator.getGamepads()){if(!e||!e.connected)continue;r=!0;let t=re[e.index];if(t||(t=re[e.index]={buttons:[],axes:Array(e.axes.length).fill(null).map(n=>({}))}),e.mapping!=="standard")for(let n=0;n<e.axes.length;n++){if(t.axes[n].isHat===!1)continue;const s=(e.axes[n]+1)*3.5,a=Math.abs(Math.round(s)-s),i=at[Math.round(s)];if(a>48e-8||i===void 0){t.axes[n].isHat=!1;continue}else{if(s===0&&t.axes[n].isHat!==!0)continue;t.axes[n].isHat=!0}for(let c=0;c<4;c++){const l=i[c];t.buttons[64+c]!==l&&(t.buttons[64+c]=l,R(`Gamepad${64+c}`,l))}}for(let n=0;n<e.axes.length;n++){const s=e.axes[n];if(t.axes[n].isHat===!0||Math.abs(s)>1)continue;const a=s<=-.5,i=s>=.5;t.axes[n].negative!==a&&(t.axes[n].negative=a,R(`GamepadAxis${n}-`,a)),t.axes[n].positive!==i&&(t.axes[n].positive=i,R(`GamepadAxis${n}+`,i))}for(let n=0;n<e.buttons.length;n++){const s=e.buttons[n].pressed;t.buttons[n]!==s&&(t.buttons[n]=s,R(`Gamepad${n}`,s))}}r?requestAnimationFrame(Re):j=!1}u(window,"gamepadconnected",r=>{r.gamepad.mapping!=="standard"&&console.warn("Non-standard gamepad attached. Mappings may be funny."),j||(j=!0,Re())});u(window,"gamepaddisconnected",r=>{re[r.gamepad.index]=null});let q=!1,ne=null,b=null;function it(){return q=!0,document.body.classList.add("mapping"),new Promise(r=>{ne=r})}function ot(){ie(),document.body.classList.remove("mapping"),q=!1,ne&&ne()}function ct(){return ie(),new Promise(r=>{b=r}).then(r=>(b=null,r))}function ie(){b&&b(null)}async function lt(r,e){const t=n=>{n.stopPropagation(),ie()};u(document.body,"mousedown",t,!0),u(document.body,"touchstart",t,!0),document.body.classList.add("capturing"),r.classList.add("mapping");try{const n=await ct();n&&(_[n]=e,S("inputMap",_))}finally{r.classList.remove("mapping"),document.body.classList.remove("capturing"),J(document.body,"touchstart",t,!0),J(document.body,"mousedown",t,!0)}}function ut(){for(const r of Object.keys(_))delete _[r];Object.assign(_,ye),S("inputMap",_)}function dt(){for(const r of Object.keys(_))delete _[r];S("inputMap",_)}let p,N=!0;async function ge(r=1){if(!(p||!N)){try{p=new AudioContext,await navigator.mediaDevices.getUserMedia({audio:!0});let e;for(;e=await ft(),!e;)if(--r>0)await X(300);else break;if(!e)throw new Error("M8 not found");const t=await navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:e},autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1}});p.createMediaStreamSource(t).connect(p.destination),p.state!=="running"&&ht()}catch(e){console.error(e),W()}N||W()}}async function ft(){return(await navigator.mediaDevices.enumerateDevices()).filter(e=>e.kind==="audioinput"&&/M8/.test(e.label)&&e.deviceId!=="default"&&e.deviceId!=="communications").map(e=>e.deviceId)[0]}async function W(){p&&await p.close().catch(()=>{}),p=null}function ht(){const r=["keydown","mousedown","touchstart"];function e(){p&&p.resume(),r.forEach(t=>J(document,t,e))}r.forEach(t=>u(document,t,e))}function _t(){N||(N=!0,ge())}function pt(){N=!1,W()}const Q=Symbol("START_LINE"),P=Symbol("HEX1"),ve=Symbol("HEX2");async function vt(r,e,t){const n=[];for await(let{address:s,data:a}of wt(r)){if(s-=t,s<0)throw new h("Negative address after applying offset");let i=Math.floor(s/e),c=0;for(;c<a.length;){let l=n[i];l||(l=n[i]=new Uint8Array(e),l.fill(255));const f=i*e,d=f+e,L=s+c-f,oe=s+a.length>d?e:L+a.length-c;for(let x=L;x<oe;x++)l[x]=a[c++];i++}}return n}async function*wt(r){const e=new Uint8Array(260);let t=Q,n=1,s=0,a=0,i=0,c=0,l=1,f=!1,d=0;const L=r.stream().getReader();for(;;){const x=await L.read();if(!x.value)break;for(const C of x.value){if(s++,f)throw new h(`Unexpected data after end record, line ${n} char ${s}`);switch(t){case Q:switch(C){case 58:t=P;break;default:throw new h(`Expecting ':' at start of line ${n} char ${s}`)}break;case P:if(C===13)continue;if(C===10){if(a<l)throw new h(`Unexpected end of line on line ${n} char ${s}`);if(c!==0)throw new h(`Invalid checksum on line ${n}`);switch(e[3]){case 0:yield{address:d+e[1]*256+e[2],data:e.subarray(4,l-1)};break;case 1:f=!0;break;case 2:d=e[4]*256+e[5]<<4;break;case 3:break;case 4:d=e[4]*256+e[5]<<16;break;case 5:break;default:throw new h(`Invalid record type on line ${n}`)}t=Q,n++,s=0,a=0,c=0,l=1}else{if(a>=l)throw new h(`Record too long on line ${n} char ${s}`);const le=we(C);if(le===null)throw new h(`Expecting hex character on line ${n} char ${s}`);i=le*16,t=ve}break;case ve:const ce=we(C);if(ce===null)throw new h(`Expecting hex character on line ${n} char ${s}`);i+=ce,c=c+i&255,a===0&&(l=i+5),e[a++]=i,t=P;break}}if(x.done)break}if(f)return;if(t!=P||byte<l)throw new h(`Unexpected end of file, line ${n} char ${s}`);if(c!==0)throw new h(`Invalid checksum on line ${n}`);if(e[3]!==1)throw new h(`Missing end of file record, line ${n}`)}function we(r){return r>=48&&r<=57?r-48:r>=65&&r<=70?r-55:r>=97&&r<=102?r-87:null}class h extends Error{constructor(...e){super(...e),this.name="HexFormatError"}}function v(r){document.getElementById("firmware").className=r}function mt(){O=null,m=null,v("file-select")}async function xt(r,e,t){t(0),await e.open();try{const n=new Uint8Array(1088);for(let s=0;s<r.length;s++){if(s!==0&&(!r[s]||r[s].every(i=>i===255)))continue;const a=s*1024;n[0]=a&255,n[1]=a>>8&255,n[2]=a>>16&255,n.set(r[s],64),await e.sendReport(0,n),t((s+1)/r.length),await X(s===0?1500:5)}n.fill(0),n[0]=255,n[1]=255,n[2]=255,await e.sendReport(0,n)}finally{await e.close().catch(()=>{})}}function At(r){const e=r.collections[0];return e&&e.usagePage===65436&&e.usage===37}let O=null,m=null;u("#firmware button.close","click",()=>{O=null,m=null,document.querySelector("#firmware input").value=null,v("hidden")});u("#firmware input","change",async r=>{O=null;const e=r.target.files[0];if(e){v("file-loading");try{O=await vt(e,1024,1610612736)}catch(t){console.error(t),v("file-error");return}v("file-loaded")}});u("#firmware button.select-device","click",async()=>{m=null;const r=await navigator.hid.requestDevice({filters:[{vendorId:5824,productId:1144}]});m=r&&r[0],m&&(At(m)?v("device-selected"):(m=null,v("device-error")))});u("#firmware button.flash","click",async()=>{const r=document.querySelector("#firmware progress.flash");v("flashing");try{await xt(O,m,e=>r.value=e)}catch(e){console.error(e),v("flash-error");return}v("flash-success")});let Te=!1,A=null;function bt(r){Te=r,K()}w("preventSleep",()=>K());u(document,"visibilitychange",()=>K());async function K(){if(!navigator.wakeLock)return;const r=Te&&g("preventSleep")&&document.visibilityState==="visible",e=A&&!A.released;if(!r&&e)A.release(),A=null;else if(r&&!e)try{A=await navigator.wakeLock.request("screen"),u(A,"release",()=>K())}catch{A=null}}function se(r,e,t){const n=`rgb(${r}, ${e}, ${t})`;document.body.style.backgroundColor=n,document.documentElement.style.backgroundColor=n,S("background",[r,e,t])}const F=H("background",[0,0,0]);se(F[0],F[1],F[2]);const Se=g("displayType")==="webgl2"?new qe(F,se):new Ne(F,se),me=new Me(Se);let z=function(){const r=document.getElementById("display"),e=document.getElementById("canvas");function t(){const n=devicePixelRatio,s=r.clientWidth*n,a=document.getElementById("screen");if(g("snapPixels")&&s<=1600){let i=r.clientHeight*n;(g("showControls")||q)&&(i/=2);const c=Math.floor(s/320)*320/n,l=Math.floor(i/240)*240/n,f=Math.round((s/n-c)/2),d=Math.round((i/n-l)/2);e.style.width=`${c}px`,e.style.height=`${l}px`,e.style.left=`${f}px`,e.style.top=`${d}px`,a&&(a.style.width=`${c}px`,a.style.height=`${l}px`,a.style.left=`${f}px`,a.style.top=`${d}px`)}else e.style.width=null,e.style.height=null,e.style.left=null,e.style.top=null,a&&(a.style.width=null,a.style.height=null,a.style.left=null,a.style.top=null)}return u(window,"resize",t),window.matchMedia("screen and (min-resolution: 2dppx)").addListener(t),t(),t}();w("showControls",r=>{document.getElementById("display").classList.toggle("with-controls",r),z()});w("enableAudio",r=>{r?_t():pt()});w("snapPixels",()=>z());w("controlMapping",()=>{y("#info"),it().then(z),z()});w("firmware",()=>{y("#info"),mt()});w("fullscreen",()=>{document.fullscreenElement?document.exitFullscreen():document.body.requestFullscreen()});w("about",()=>G("#info"));function xe(r){r?(y("#buttons, .error, #info"),ge(10)):(Se.clear(),G("#buttons"),W()),bt(r)}navigator.serial?Ae(new Be(me,xe),"#serial-fail"):navigator.usb?Ae(new De(me,xe),"#usb-fail"):G("#no-serial-usb");function Ae(r,e){st(r),u("#connect","click",()=>r.connect().catch(()=>{y("#info"),G(e)})),u(window,"beforeunload",t=>r.disconnect()),r.connect(!0).catch(()=>{})}u("#info button","click",()=>y("#info"));Qe();
